import logging
import random
import asyncio
from datetime import datetime
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∑–∞–º–µ–Ω—ã —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤ –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏
REPLACEMENT_MAP = {
    '–∞': 'a',  # —Ä—É—Å—Å–∫–∞—è '–∞' –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫—É—é 'a'
    '–µ': 'e',  # —Ä—É—Å—Å–∫–∞—è '–µ' –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫—É—é 'e'
    '—Å': 'c',  # —Ä—É—Å—Å–∫–∞—è '—Å' –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫—É—é 'c'
    '–æ': 'o',  # —Ä—É—Å—Å–∫–∞—è '–æ' –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫—É—é 'o'
    '—Ä': 'p',  # —Ä—É—Å—Å–∫–∞—è '—Ä' –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫—É—é 'p'
    '—Ö': 'x',  # —Ä—É—Å—Å–∫–∞—è '—Ö' –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫—É—é 'x'
    '—É': 'y',  # —Ä—É—Å—Å–∫–∞—è '—É' –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫—É—é 'y'
    '–ê': 'A',  # –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã
    '–ï': 'E',
    '–°': 'C',
    '–û': 'O',
    '–†': 'P',
    '–•': 'X',
    '–£': 'Y'
}

def replace_letters_with_chance(text: str, chance: float = 0.5) -> str:
    """
    –ó–∞–º–µ–Ω—è–µ—Ç —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º —à–∞–Ω—Å–æ–º.
    
    Args:
        text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
        chance: –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–º–µ–Ω—ã (–æ—Ç 0 –¥–æ 1)
    
    Returns:
        –¢–µ–∫—Å—Ç —Å –∑–∞–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
    """
    result = []
    
    for char in text:
        # –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –µ—Å—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ –∑–∞–º–µ–Ω –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–Ω—Å 50%
        if char in REPLACEMENT_MAP and random.random() < chance:
            result.append(REPLACEMENT_MAP[char])
        else:
            result.append(char)
    
    return ''.join(result)

async def process_text_with_timeout(text: str, timeout: float = 2.0) -> str:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
    
    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        timeout: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    
    Returns:
        –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    """
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        result = await asyncio.wait_for(
            asyncio.to_thread(replace_letters_with_chance, text),
            timeout=timeout
        )
        return result
    except asyncio.TimeoutError:
        return "‚è∞ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (2 —Å–µ–∫—É–Ω–¥—ã). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ–∫–æ—Ä–æ—á–µ."
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {str(e)}"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    
    # –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    welcome_text = (
        "‚ú® *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Text Transformer Bot!*\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        f"üëã –ü—Ä–∏–≤–µ—Ç, *{user.first_name}*!\n\n"
        "üéØ *–ß—Ç–æ —É–º–µ–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç:*\n"
        "‚Ä¢ –ó–∞–º–µ–Ω—è–µ—Ç —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏:\n"
        "  `–∞ –µ —Å –æ —Ä —Ö —É` ‚Üí `a e c o p x y`\n"
        "‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–º–µ–Ω—ã –∫–∞–∂–¥–æ–π –±—É–∫–≤—ã: *50%*\n"
        "‚Ä¢ –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏: *2 —Å–µ–∫—É–Ω–¥—ã*\n\n"
        "üìù *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
        "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ –ª—é–±–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üí° *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
        "`/start` - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
        "`/help` - –ü–æ–º–æ—â—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏\n"
        "`/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\n"
        "`/example` - –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã\n\n"
        "üöÄ *–ù–∞—á–Ω–∏—Ç–µ —Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!*"
    )
    
    await update.message.reply_text(
        welcome_text,
        parse_mode='Markdown',
        reply_markup=None
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "üìö *–ü–æ–º–æ—â—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏*\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        "üé® *–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–∞:*\n\n"
        "–ë–æ—Ç –∑–∞–º–µ–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã:\n"
        "```\n"
        "–∞ ‚Üí a (—à–∞–Ω—Å 50%)\n"
        "–µ ‚Üí e (—à–∞–Ω—Å 50%)\n"
        "—Å ‚Üí c (—à–∞–Ω—Å 50%)\n"
        "–æ ‚Üí o (—à–∞–Ω—Å 50%)\n"
        "—Ä ‚Üí p (—à–∞–Ω—Å 50%)\n"
        "—Ö ‚Üí x (—à–∞–Ω—Å 50%)\n"
        "—É ‚Üí y (—à–∞–Ω—Å 50%)\n"
        "```\n\n"
        "‚è± *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:*\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: *2 —Å–µ–∫—É–Ω–¥—ã*\n"
        "‚Ä¢ –ö–∞–∂–¥–∞—è –±—É–∫–≤–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        "üíé *–ü—Ä–∏–º–µ—Ä—ã –∑–∞–º–µ–Ω—ã:*\n"
        "‚Ä¢ `–ü—Ä–∏–≤–µ—Ç` ‚Üí `–ü—Ä–∏–≤–µ—Ç` (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)\n"
        "‚Ä¢ `–ü—Ä–∏–≤–µ—Ç` ‚Üí `Pp–∏–≤–µ—Ç` (—á–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–º–µ–Ω–∞)\n"
        "‚Ä¢ `–•–æ—Ä–æ—à–æ` ‚Üí `–•–æ—Ä–æ—à–æ` –∏–ª–∏ `X–æ—Ä–æ—à–æ`\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üìå *–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /example –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏*"
    )
    
    await update.message.reply_text(
        help_text,
        parse_mode='Markdown'
    )

async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats"""
    stats_text = (
        "üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞*\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        "üïí *–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:*\n"
        f"–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: `{datetime.now().strftime('%H:%M:%S')}`\n"
        f"–î–∞—Ç–∞: `{datetime.now().strftime('%d.%m.%Y')}`\n\n"
        
        "‚öôÔ∏è *–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:*\n"
        "‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–º–µ–Ω—ã: *50%*\n"
        "‚Ä¢ –¢–∞–π–º–∞—É—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏: *2 —Å–µ–∫—É–Ω–¥—ã*\n"
        "‚Ä¢ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –±—É–∫–≤—ã: *7 –ø–∞—Ä*\n\n"
        
        "üî§ *–°–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω:*\n"
        "```\n"
        "–∞ –µ —Å –æ —Ä —Ö —É\n"
        "‚Üì ‚Üì ‚Üì ‚Üì ‚Üì ‚Üì ‚Üì\n"
        "a e c o p x y\n"
        "```\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üìà *–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!*"
    )
    
    await update.message.reply_text(
        stats_text,
        parse_mode='Markdown'
    )

async def example_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /example"""
    example_text = (
        "üé≠ *–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞*\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        "üí¨ *–¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã:*\n\n"
    )
    
    test_examples = [
        ("–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?", "üîπ –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è"),
        ("–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏", "üîπ –ü—Ä–∏–º–µ—Ä —Å —Ä–∞–∑–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏"),
        ("–°–ª–æ–∂–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏", "üîπ –ü—Ä–∏–º–µ—Ä —Å —á–∞—Å—Ç—ã–º–∏ –∑–∞–º–µ–Ω—è–µ–º—ã–º–∏ –±—É–∫–≤–∞–º–∏"),
        ("–†—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç", "üîπ –ü—Ä–∏–º–µ—Ä —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"),
        ("–£—Ö —Ç—ã! –≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "üîπ –ü—Ä–∏–º–µ—Ä —Å –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–µ–º")
    ]
    
    for i, (text, description) in enumerate(test_examples, 1):
        example_text += f"*–ü—Ä–∏–º–µ—Ä {i}:* {description}\n"
        example_text += f"üìù *–ò—Å—Ö–æ–¥–Ω—ã–π:* `{text}`\n"
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
        variants = []
        for j in range(3):
            random.seed(i + j)  # –§–∏–∫—Å–∏—Ä—É–µ–º seed –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–º–µ—Ä–∞
            variants.append(replace_letters_with_chance(text))
        
        example_text += f"‚ú® *–í–∞—Ä–∏–∞–Ω—Ç—ã:*\n"
        for j, variant in enumerate(variants, 1):
            example_text += f"  {j}. `{variant}`\n"
        example_text += "\n"
    
    example_text += (
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üí° *–ö–∞–∂–¥—ã–π —Ä–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Ä–∞–∑–Ω—ã–º –∏–∑-–∑–∞ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ 50%!*"
    )
    
    await update.message.reply_text(
        example_text,
        parse_mode='Markdown'
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –∫—Ä–∞—Å–∏–≤—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º"""
    user_message = update.message.text
    
    if not user_message.strip():
        await update.message.reply_text(
            "üì≠ *–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ*\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.",
            parse_mode='Markdown'
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await update.message.reply_text(
        "üîÑ *–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞—Ç–∞...*\n"
        "‚è± –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏: 2 —Å–µ–∫—É–Ω–¥—ã",
        parse_mode='Markdown'
    )
    
    try:
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        processed_text = await process_text_with_timeout(user_message)
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
        await processing_msg.delete()
        
        # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        timestamp = datetime.now().strftime("%H:%M:%S")
        
        # –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        original_chars = len(user_message)
        replaced_chars = sum(1 for a, b in zip(user_message, processed_text) if a != b)
        
        result_text = (
            f"‚úÖ *–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!*\n"
            f"üïí `{timestamp}`\n\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"üì• *–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç ({original_chars} —Å–∏–º–≤–æ–ª–æ–≤):*\n"
            f"```\n{user_message}\n```\n\n"
            f"üì§ *–†–µ–∑—É–ª—å—Ç–∞—Ç ({replaced_chars} –∑–∞–º–µ–Ω):*\n"
            f"```\n{processed_text}\n```\n\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:* {replaced_chars}/{original_chars} –∑–∞–º–µ–Ω "
            f"({(replaced_chars/original_chars*100):.1f}%)\n\n"
            "üé≤ *–°–ª—É—á–∞–π–Ω–æ—Å—Ç—å: 50% –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É*"
        )
        
        await update.message.reply_text(
            result_text,
            parse_mode='Markdown'
        )
        
    except Exception as e:
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        try:
            await processing_msg.delete()
        except:
            pass
        
        await update.message.reply_text(
            f"‚ùå *–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏*\n\n"
            f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: `{str(e)}`\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
            parse_mode='Markdown'
        )

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è {update}: {context.error}")
    
    try:
        error_text = (
            "‚ö†Ô∏è *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞*\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.\n\n"
            "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /help"
        )
        
        await update.message.reply_text(
            error_text,
            parse_mode='Markdown'
        )
    except:
        pass

def main() -> None:
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    # –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π)
    BOT_TOKEN = "8334892286:AAH7P7zzS6Uie3Sb8Llglg-BqiXBxais6VE"
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("stats", stats_command))
    application.add_handler(CommandHandler("example", example_command))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    application.add_error_handler(error_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("üéâ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print("ü§ñ Text Transformer Bot")
    print("‚ú® –ó–∞–º–µ–Ω–∞ –±—É–∫–≤ —Å —à–∞–Ω—Å–æ–º 50%")
    print("‚è± –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏: 2 —Å–µ–∫—É–Ω–¥—ã")
    print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()